# Configuração no Render

Este documento descreve o processo de configuração do serviço no ambiente Render.

## Variáveis de Ambiente

Adicione as seguintes variáveis de ambiente no painel do Render:

| Variável | Descrição | Obrigatória |
|----------|-----------|-------------|
| `MAXMIND_LICENSE_KEY` | Chave de licença para download da base GeoIP | Sim |
| `DEBUG_GEOIP` | Habilita logs de debug para o GeoIP (true/false) | Não |
| `DATABASE_URL` | URL de conexão com o banco de dados | Sim |
| `NODE_ENV` | Ambiente de execução | Sim |
| `PORT` | Porta em que o serviço será executado | Não (padrão: 3000) |

## Configuração do GeoIP

Para garantir que a geolocalização funcione corretamente, é necessário configurar a variável `MAXMIND_LICENSE_KEY` com uma chave de licença válida do MaxMind. Para obter uma chave:

1. Crie uma conta gratuita em [MaxMind](https://www.maxmind.com/en/geolite2/signup)
2. Faça login e acesse "My License Key" no menu da conta
3. Gere uma nova chave de licença para download da base GeoLite2
4. Copie a chave e adicione à variável de ambiente `MAXMIND_LICENSE_KEY` no Render

## Problemas Comuns

### Erro 401 ou 302 no Download da Base GeoIP

```
Erro fatal: Error: Falha no download. Status code: 401
```

Este erro indica problemas com a chave de licença ou com o redirecionamento da URL de download. Verifique:

1. Se a variável `MAXMIND_LICENSE_KEY` está configurada no Render
2. Se a chave de licença é válida e tem permissão para baixar a base GeoLite2-City
3. Se a conta MaxMind não expirou

### Correção Manual da Base GeoIP

Para atualizar a base GeoIP manualmente usando o shell do Render:

1. Acesse o shell do serviço no Render
2. Execute o seguinte comando:

```bash
bash /opt/render/project/src/scripts/download-geoip.sh
```

## Inicialização do Serviço

O serviço agora inicia diretamente, sem tentar atualizar a base GeoIP automaticamente:

```
node src/index.js
```

A atualização da base deve ser feita manualmente quando necessário, usando o script download-geoip.sh.

O sistema de fallback para IPs brasileiros garantirá o funcionamento do serviço mesmo com problemas na base GeoIP.

## Monitoramento

Para monitorar problemas relacionados ao GeoIP, configure a variável `DEBUG_GEOIP=true` e verifique os logs do serviço no painel do Render.

## Gerenciadores de Pacotes

Este projeto utiliza exclusivamente o Yarn como gerenciador de pacotes. Para evitar avisos e potenciais conflitos de resolução de dependências, certifique-se de que:

1. O arquivo `package-lock.json` foi removido do repositório
2. O arquivo `package-lock.json` está listado no `.gitignore`
3. Todos os comandos de instalação no Render são executados com `yarn` e não com `npm`

Se você vir o aviso abaixo no log do Render, isso significa que há um `package-lock.json` no repositório:

```
warning package-lock.json found. Your project contains lock files generated by tools other than Yarn. It is advised not to mix package managers in order to avoid resolution inconsistencies caused by unsynchronized lock files. To clear this warning, remove package-lock.json.
```

Para resolver:
1. Remova o arquivo do repositório: `git rm package-lock.json`
2. Adicione ao `.gitignore`: `echo "package-lock.json" >> .gitignore`
3. Faça commit e push das alterações
4. Faça um novo deploy no Render 