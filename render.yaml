services:
  - type: web
    name: traq-api
    env: node
    buildCommand: yarn
    startCommand: yarn start
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: DATABASE_URL
        fromDatabase:
          name: traq-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_ACCESS_EXPIRATION_MINUTES
        value: 30
      - key: JWT_REFRESH_EXPIRATION_DAYS
        value: 30
      - key: LOG_LEVEL
        value: info
      - key: GEOIP_DB_PATH
        value: ./data/GeoLite2-City.mmdb
      - key: YAMPI_WEBHOOK_SECRET
        sync: false
    healthCheckPath: /v1/health
    autoDeploy: true
    plan: free
    headers:
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
      - path: /*
        name: Strict-Transport-Security
        value: max-age=31536000; includeSubDomains
      - path: /*
        name: Content-Security-Policy
        value: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';
    buildFilter:
      paths:
        - src/**/*
        - prisma/**/*
        - package.json
        - yarn.lock 